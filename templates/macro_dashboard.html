{% extends "base.html" %}

{% block title %}Macro Dashboard - Vallionis AI Finance{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="mb-0">Macroeconomic Dashboard</h1>
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" id="layout-3col" onclick="toggleLayout('3col')">
                    <i class="fas fa-th me-1"></i> 3 Columns
                </button>
                <button type="button" class="btn btn-outline-secondary" id="layout-1col" onclick="toggleLayout('1col')">
                    <i class="fas fa-list me-1"></i> 1 Column
                </button>
            </div>
            <a href="{{ url_for('export_all') }}" class="btn btn-primary">
                <i class="fas fa-file-download me-2"></i> Download All
            </a>
        </div>
    </div>
    {% if using_demo %}
    <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Displaying demo data due to API unavailability. Values are simulated for illustration.
    </div>
    {% endif %}
    
    <!-- Economic Indicators Overview -->
    {% if indicators %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Key Economic Indicators</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">GDP (Nominal)</h5>
                                    <h3 class="mb-0">${{ "%.1f"|format(indicators.nominal_gdp.latest_value) }}B</h3>
                                    <small class="text-muted">Current Dollars</small>
                                    <div class="mt-2">
                                        <small>Last updated: {{ indicators.nominal_gdp.latest_date }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Inflation</h5>
                                    {% set infl = indicators.get('inflation_metrics') %}
                                    {% if infl %}
                                        <div class="d-flex align-items-baseline mb-1">
                                            <span class="me-2">MoM:</span>
                                            <h3 class="mb-0">{{ infl.mom_percent|round(2) }}%</h3>
                                        </div>
                                        <small class="text-muted">Month-over-month change</small>
                                        <div class="mt-2">
                                            <span class="badge bg-light text-dark me-2">YoY: {{ infl.yoy_percent|round(2) }}%</span>
                                            <small class="text-muted">CPI level: {{ infl.cpi_level|round(1) }}</small>
                                        </div>
                                        <div class="mt-1">
                                            <small>Last updated: {{ infl.latest_date }}</small>
                                        </div>
                                    {% else %}
                                        <h3 class="mb-0">â€”</h3>
                                        <small class="text-muted">Month-over-month change</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Unemployment Rate</h5>
                                    <h3 class="mb-0">{{ "%.1f"|format(indicators.unemployment.latest_value) }}%</h3>
                                    <small class="text-muted">% of labor force</small>
                                    <div class="mt-2">
                                        <small>Last updated: {{ indicators.unemployment.latest_date }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Individual Charts Section -->
    <div class="row" id="charts-container">
        <!-- Nominal GDP Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Nominal GDP</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='nominal_gdp') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'nominal_gdp' in charts %}
                        {{ charts.nominal_gdp|safe }}
                    {% else %}
                        <div class="alert alert-warning">Nominal GDP chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Inflation YoY Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Inflation (YoY)</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='inflation') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'inflation_yoy' in charts %}
                        {{ charts.inflation_yoy|safe }}
                    {% else %}
                        <div class="alert alert-warning">Inflation YoY chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Inflation MoM Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Inflation (MoM)</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='inflation') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'inflation_mom' in charts %}
                        {{ charts.inflation_mom|safe }}
                    {% else %}
                        <div class="alert alert-warning">Inflation MoM chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Unemployment Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Unemployment Rate</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='unemployment') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'unemployment' in charts %}
                        {{ charts.unemployment|safe }}
                    {% else %}
                        <div class="alert alert-warning">Unemployment chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Federal Funds Rate Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Federal Funds Rate</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='fed_funds') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'fed_funds' in charts %}
                        {{ charts.fed_funds|safe }}
                    {% else %}
                        <div class="alert alert-warning">Federal Funds Rate chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 10-Year Treasury Yield Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">10-Year Treasury Yield</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='treasury_10y') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'treasury_10y' in charts %}
                        {{ charts.treasury_10y|safe }}
                    {% else %}
                        <div class="alert alert-warning">10-Year Treasury Yield chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 2-Year Treasury Yield Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">2-Year Treasury Yield</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='treasury_2y') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'treasury_2y' in charts %}
                        {{ charts.treasury_2y|safe }}
                    {% else %}
                        <div class="alert alert-warning">2-Year Treasury Yield chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 2/10 Yield Curve Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">2/10 Yield Curve</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='yield_curve_2_10') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'yield_curve_2_10' in charts %}
                        {{ charts.yield_curve_2_10|safe }}
                    {% else %}
                        <div class="alert alert-warning">2/10 Yield Curve chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Job Openings (JOLTS) Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Job Openings (JOLTS)</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='jolts') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'jolts' in charts %}
                        {{ charts.jolts|safe }}
                    {% else %}
                        <div class="alert alert-warning">Job Openings chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Jobless Claims Chart -->
        <div class="col-lg-4 col-md-6 mb-4 chart-card">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Jobless Claims</h5>
                    <a href="{{ url_for('export_indicator', indicator_key='jobless_claims') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i> CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if charts and 'jobless_claims' in charts %}
                        {{ charts.jobless_claims|safe }}
                    {% else %}
                        <div class="alert alert-warning">Jobless Claims chart is currently unavailable.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Plotly.js for interactive charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
// Store the current layout in localStorage for persistence
function setLayoutPreference(layout) {
    localStorage.setItem('dashboardLayout', layout);
}

function getLayoutPreference() {
    return localStorage.getItem('dashboardLayout') || '3col';
}

function applyLayout(layout) {
    const chartCards = document.querySelectorAll('.chart-card');
    const btn3col = document.getElementById('layout-3col');
    const btn1col = document.getElementById('layout-1col');

    // Update button states
    if (layout === '3col') {
        btn3col.classList.add('active');
        btn1col.classList.remove('active');

        // Apply 3-column layout
        chartCards.forEach(card => {
            card.classList.remove('col-12');
            card.classList.add('col-lg-4', 'col-md-6');
        });
    } else {
        btn1col.classList.add('active');
        btn3col.classList.remove('active');

        // Apply 1-column layout
        chartCards.forEach(card => {
            card.classList.remove('col-lg-4', 'col-md-6');
            card.classList.add('col-12');
        });
    }

    // Save preference
    setLayoutPreference(layout);

    // Resize charts after layout change
    setTimeout(() => {
        const charts = document.querySelectorAll('.js-plotly-plot');
        for (let i = 0; i < charts.length; i++) {
            Plotly.Plots.resize(charts[i]);
        }
    }, 100);
}

function toggleLayout(layout) {
    applyLayout(layout);
}

// Initialize layout on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedLayout = getLayoutPreference();
    applyLayout(savedLayout);

    // Make tables responsive
    document.querySelectorAll('table').forEach(table => {
        table.classList.add('table-responsive');
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Make charts responsive on window resize
window.addEventListener('resize', function() {
    const charts = document.querySelectorAll('.js-plotly-plot');
    for (let i = 0; i < charts.length; i++) {
        Plotly.Plots.resize(charts[i]);
    }
});
</script>
{% endblock %}
