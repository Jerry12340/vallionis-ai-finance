{% extends "base.html" %}

{% block title %}AI Coach - Vallionis AI Finance{% endblock %}

{% block styles %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
    }
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        font-weight: 600;
    }
    .macro-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        border: none;
    }
    .macro-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        font-weight: 600;
    }
    .analysis-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .risk-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
    .risk-item:last-child {
        border-bottom: none;
    }
    .risk-high {
        border-left: 4px solid #dc3545;
        padding-left: 1rem;
    }
    .risk-medium {
        border-left: 4px solid #ffc107;
        padding-left: 1rem;
    }
    .risk-low {
        border-left: 4px solid #198754;
        padding-left: 1rem;
    }
    .opportunity-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
    .opportunity-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-line me-2"></i>AI Finance Coach</h2>
            <p class="text-muted">Get insights and analysis on financial markets and economic indicators</p>
            
            <ul class="nav nav-tabs mb-4" id="coachTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'chat' %}active{% endif %}" 
                            id="chat-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#chat-tab-pane" 
                            type="button" 
                            role="tab"
                            onclick="window.location.href='{{ url_for('ai_coach') }}'">
                        <i class="fas fa-comments me-1"></i> Chat with AI
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'macro' %}active{% endif %}" 
                            id="macro-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#macro-tab-pane" 
                            type="button" 
                            role="tab"
                            onclick="window.location.href='{{ url_for('macro_dashboard') }}'">
                        <i class="fas fa-chart-pie me-1"></i> Macro Dashboard
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="coachTabsContent">
        <!-- Chat Tab -->
        <div class="tab-pane fade {% if active_tab == 'chat' %}show active{% endif %}" 
             id="chat-tab-pane" 
             role="tabpanel" 
             aria-labelledby="chat-tab">
            <div class="chat-container">
                <div id="chat-box" class="chat-box"></div>
                <form id="chat-form">
                    <div class="input-group">
                        <textarea id="user-input" class="form-control" placeholder="Ask me anything about investing..." rows="1" autocomplete="off" required></textarea>
                        <button id="send-btn" class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Macro Dashboard Tab -->
        <div class="tab-pane fade {% if active_tab == 'macro' %}show active{% endif %}" 
             id="macro-tab-pane" 
             role="tabpanel" 
             aria-labelledby="macro-tab">
            {% if analysis %}
            <div class="analysis-section mb-4">
                <h4><i class="fas fa-chart-line me-2"></i>Macro Economic Overview</h4>
                <p>{{ analysis.overview }}</p>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Potential Risks</h5>
                        <div class="mt-3">
                            {% for risk in analysis.risks %}
                            <div class="risk-item risk-{{ 'high' if 'high' in risk|lower else 'medium' }}">
                                <i class="fas fa-exclamation-circle me-2"></i> {{ risk }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-lightbulb me-2 text-success"></i>Opportunities</h5>
                        <div class="mt-3">
                            {% for opportunity in analysis.opportunities %}
                            <div class="opportunity-item">
                                <i class="fas fa-arrow-circle-up me-2 text-success"></i> {{ opportunity }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="row">
                {% if macro_data %}
                    {% for indicator, data in macro_data.items() %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card macro-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>{{ data.name }}</span>
                                <span class="badge bg-primary">{{ data.unit }}</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chart-{{ indicator }}"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading economic data...</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Initialize macro charts if we're on the macro dashboard
        if (document.getElementById('macro-tab-pane') && document.getElementById('macro-tab-pane').classList.contains('show')) {
            initializeMacroCharts();
        }
    });

    // Function to initialize all macro charts
    function initializeMacroCharts() {
        {% if macro_data %}
            // Chart configuration
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString(undefined, {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'year',
                            tooltipFormat: 'MMM yyyy',
                            displayFormats: {
                                month: 'MMM yyyy',
                                year: 'yyyy'
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            };

            // Create a chart for each indicator
            {% for indicator, data in macro_data.items() %}
                {% if data.data %}
                    const ctx{{ loop.index }} = document.getElementById('chart-{{ indicator }}').getContext('2d');
                    const dates{{ loop.index }} = {{ data.data|map(attribute='date')|tojson|safe }};
                    const values{{ loop.index }} = {{ data.data|map(attribute='value')|tojson|safe }};
                    
                    // Determine chart type and styling based on indicator
                    let chartType = 'line';
                    let borderColor = '#0d6efd';
                    let backgroundColor = 'rgba(13, 110, 253, 0.1)';
                    let fill = true;
                    
                    // Customize chart appearance based on indicator type
                    switch('{{ indicator }}') {
                        case 'inflation':
                            borderColor = '#dc3545';
                            backgroundColor = 'rgba(220, 53, 69, 0.1)';
                            break;
                        case 'gdp':
                            borderColor = '#198754';
                            backgroundColor = 'rgba(25, 135, 84, 0.1)';
                            chartType = 'bar';
                            fill = false;
                            break;
                        case 'unemployment':
                            borderColor = '#6f42c1';
                            backgroundColor = 'rgba(111, 66, 193, 0.1)';
                            break;
                        case 'fed_funds':
                            borderColor = '#fd7e14';
                            backgroundColor = 'rgba(253, 126, 20, 0.1)';
                            break;
                        case 'treasury_10y':
                            borderColor = '#20c997';
                            backgroundColor = 'rgba(32, 201, 151, 0.1)';
                            break;
                    }
                    
                    new Chart(ctx{{ loop.index }}, {
                        type: chartType,
                        data: {
                            labels: dates{{ loop.index }},
                            datasets: [{
                                label: '{{ data.name }}',
                                data: values{{ loop.index }},
                                borderColor: borderColor,
                                backgroundColor: chartType === 'line' ? backgroundColor : borderColor,
                                borderWidth: 2,
                                pointRadius: 1.5,
                                pointHoverRadius: 4,
                                tension: 0.3,
                                fill: fill
                            }]
                        },
                        options: {
                            ...chartConfig,
                            plugins: {
                                ...chartConfig.plugins,
                                title: {
                                    display: true,
                                    text: '{{ data.name }}',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        bottom: 10
                                    }
                                },
                                subtitle: {
                                    display: true,
                                    text: '{{ data.unit }}',
                                    color: '#6c757d',
                                    font: {
                                        size: 12
                                    },
                                    padding: {
                                        bottom: 20
                                    }
                                }
                            },
                            scales: {
                                ...chartConfig.scales,
                                y: {
                                    ...chartConfig.scales.y,
                                    title: {
                                        display: true,
                                        text: '{{ data.unit }}',
                                        color: '#6c757d',
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                {% endif %}
            {% endfor %}
        {% endif }
    }
    
    // Chat functionality
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    // Basic HTML escape to prevent XSS
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Very small, safe-ish Markdown renderer for bold/italic/inline-code + line breaks
    function renderMarkdownSafe(str) {
        let s = escapeHtml(str);
        // inline code first to avoid interfering with * patterns
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        // bold **text**
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // italic *text*
        s = s.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
        // line breaks
        s = s.replace(/\n/g, '<br>');
        return s;
    }

    // Helper to append messages
    function addMessage(sender, text) {
        const msg = document.createElement("div");
        msg.classList.add("message", sender);
        const label = `<strong>${sender === "user" ? "You" : "AI"}:</strong> `;
        const body = sender === "ai" ? renderMarkdownSafe(text) : escapeHtml(text);
        msg.innerHTML = label + body;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight; // auto scroll
    }

    chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        // Show user message
        addMessage("user", message);
        userInput.value = "";
        // Reset textarea height after send
        autoResizeTextarea(userInput, 8);

        // Show loading message
        const loading = document.createElement("div");
        loading.classList.add("message", "ai");
        loading.textContent = "AI is thinking...";
        chatBox.appendChild(loading);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Disable input while processing
        userInput.disabled = true;
        sendBtn.disabled = true;
        const originalBtnText = sendBtn.textContent;
        sendBtn.textContent = "Processing...";

        // AbortController for timeout
        const controller = new AbortController();
        const timeoutMs = 600000; // 600s safety timeout
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
            const response = await fetch("/api/ai/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message }),
                signal: controller.signal
            });

            // Handle non-OK responses explicitly
            if (!response.ok) {
                let errText = "Service error.";
                try {
                    const errJson = await response.json();
                    // Friendly handling for token limit
                    if (response.status === 413 && errJson?.code === 'TOKEN_LIMIT') {
                        if (loading && loading.parentNode) {
                            chatBox.removeChild(loading);
                        }
                        const msg = errJson.message || 'You have used too many tokens for your current plan.';
                        const tier = errJson.tier ? ` (plan: ${errJson.tier})` : '';
                        addMessage("ai", `⚠️ ${msg}${tier}`);
                        return;
                    }
                    errText = errJson?.error || JSON.stringify(errJson);
                } catch (_) {}
                if (loading && loading.parentNode) {
                    chatBox.removeChild(loading);
                }
                addMessage("ai", `⚠️ ${errText}`);
                return;
            }

            const data = await response.json();
            if (loading && loading.parentNode) {
                chatBox.removeChild(loading); // remove loading text
            }

            const reply = data.reply || data.response || data.message;
            if (reply) {
                addMessage("ai", reply);
            } else {
                addMessage("ai", "⚠️ Sorry, something went wrong.");
            }
        } catch (error) {
            console.error(error);
            if (loading && loading.parentNode) {
                chatBox.removeChild(loading);
            }
            if (error.name === 'AbortError') {
                addMessage("ai", "⚠️ The request timed out. Please try again.");
            } else {
                addMessage("ai", "⚠️ Error contacting AI.");
            }
        } finally {
            clearTimeout(timeoutId);
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = originalBtnText;
            userInput.focus();
        }
    });

    // Auto-grow textarea up to 8 lines, then scroll
    function autoResizeTextarea(el, maxLines = 8) {
        const style = window.getComputedStyle(el);
        const lineHeight = parseFloat(style.lineHeight) || 20; // fallback
        const borderTop = parseFloat(style.borderTopWidth) || 0;
        const borderBottom = parseFloat(style.borderBottomWidth) || 0;
        const paddingTop = parseFloat(style.paddingTop) || 0;
        const paddingBottom = parseFloat(style.paddingBottom) || 0;
        const maxHeight = maxLines * lineHeight + paddingTop + paddingBottom + borderTop + borderBottom;

        el.style.height = 'auto';
        const newHeight = Math.min(el.scrollHeight, maxHeight);
        el.style.height = newHeight + 'px';
        el.style.overflowY = el.scrollHeight > maxHeight ? 'auto' : 'hidden';
    }

    // Initialize and bind
    autoResizeTextarea(userInput, 8);
    userInput.addEventListener('input', () => autoResizeTextarea(userInput, 8));
</script>

<style>
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1.5rem;
        background: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        box-shadow: 0 4px 10px var(--color-card-shadow);
    }

    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1rem;
        background: var(--color-bg-secondary);
        margin-bottom: 1rem;
    }

    .message {
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    .message.user {
        text-align: right;
        color: var(--color-primary);
    }

    .message.ai {
        text-align: left;
        color: var(--color-text);
    }

    #chat-form {
        display: flex;
        gap: 0.5rem;
    }

    #user-input {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    #chat-form button {
        padding: 0.75rem 1.25rem;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    #chat-form button:hover {
        background: var(--color-primary-hover);
    }
</style>
{% endblock %}
