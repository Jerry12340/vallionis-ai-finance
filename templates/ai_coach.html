{% extends "base.html" %}

{% block title %}AI Coach - Vallionis AI Finance{% endblock %}

{% block content %}
<div class="chat-container">
    <h2>üí¨ AI Finance Coach</h2>
    <div id="chat-box" class="chat-box"></div>

    <form id="chat-form">
        <input type="text" id="user-input" placeholder="Ask me anything about investing..." autocomplete="off" required>
        <button id="send-btn" type="submit">Send</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    // Helper to append messages
    function addMessage(sender, text) {
        const msg = document.createElement("div");
        msg.classList.add("message", sender);
        msg.innerHTML = `<strong>${sender === "user" ? "You" : "AI"}:</strong> ${text}`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight; // auto scroll
    }

    chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        // Show user message
        addMessage("user", message);
        userInput.value = "";

        // Show loading message
        const loading = document.createElement("div");
        loading.classList.add("message", "ai");
        loading.textContent = "AI is thinking...";
        chatBox.appendChild(loading);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Disable input while processing
        userInput.disabled = true;
        sendBtn.disabled = true;
        const originalBtnText = sendBtn.textContent;
        sendBtn.textContent = "Processing...";

        // AbortController for timeout
        const controller = new AbortController();
        const timeoutMs = 30000; // 30s safety timeout
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
            const response = await fetch("/api/ai/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message }),
                signal: controller.signal
            });

            // Handle non-OK responses explicitly
            if (!response.ok) {
                let errText = "Service error.";
                try {
                    const errJson = await response.json();
                    errText = errJson?.error || JSON.stringify(errJson);
                } catch (_) {}
                if (loading && loading.parentNode) {
                    chatBox.removeChild(loading);
                }
                addMessage("ai", `‚ö†Ô∏è ${errText}`);
                return;
            }

            const data = await response.json();
            if (loading && loading.parentNode) {
                chatBox.removeChild(loading); // remove loading text
            }

            if (data.reply) {
                addMessage("ai", data.reply);
            } else {
                addMessage("ai", "‚ö†Ô∏è Sorry, something went wrong.");
            }
        } catch (error) {
            console.error(error);
            if (loading && loading.parentNode) {
                chatBox.removeChild(loading);
            }
            if (error.name === 'AbortError') {
                addMessage("ai", "‚ö†Ô∏è The request timed out. Please try again.");
            } else {
                addMessage("ai", "‚ö†Ô∏è Error contacting AI.");
            }
        } finally {
            clearTimeout(timeoutId);
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = originalBtnText;
            userInput.focus();
        }
    });
</script>

<style>
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1.5rem;
        background: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        box-shadow: 0 4px 10px var(--color-card-shadow);
    }

    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1rem;
        background: var(--color-bg-secondary);
        margin-bottom: 1rem;
    }

    .message {
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    .message.user {
        text-align: right;
        color: var(--color-primary);
    }

    .message.ai {
        text-align: left;
        color: var(--color-text);
    }

    #chat-form {
        display: flex;
        gap: 0.5rem;
    }

    #user-input {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    #chat-form button {
        padding: 0.75rem 1.25rem;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    #chat-form button:hover {
        background: var(--color-primary-hover);
    }
</style>
{% endblock %}
